# Multivariate Time Series Modeling

```{r setup5, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=TRUE, warning=FALSE, message=FALSE)
options(digits=4, width=60)
library(fpp3)
library(patchwork)
library(purrr)
library(tidyverse)

```

\pagenumbering{arabic}

**This chapter is heavily based on Chapter 13 of @chatfield2019analysis and @tsay2013multivariate .**

## Introduction

- Multivariate time series analysis considers observations taken  simultaneously on two or more time series.
- Focus of multivariate time series analysis 
     - Study the dynamic relationships between variables
     - Serial dependence **within** each series and the interdependence **between** series.
     - Improve the accuracy of prediction
- Challengers with Multivariate models
   - Model building process is more difficult for multivariate than univariate models
   - More variables to measure (More change of mistakes in the data)
   - More parameters to estimate
   - Wider pool of candidate models
   - More vulnerable to specification than simpler univariate models.
   - Balance between parsimonious modelling and accurate identification.

\newpage 

## The Cross-Correlation Function
   
- Cross-correlation function is a key tool in multivariate time series analysis.
- Let $\{\mathbf{X}_t\}$ is an *m-variate* multivariate process, where $\mathbf{X}_t^T = (X_{1t}, X_{2t}, \dots, X_{mt})$

**Cross-covariance**

- Let $\mathbf{\mu}_t$ be the vector of **mean** values of $\{\mathbf{X}_t\}$ at time t.
- Then its $i$th component is $\mu_{it}=E(X_{it})$.
- Let $\Gamma(t,t+k)$ be the **cross-covariance matrix** of $\mathbf{X}_t$ and $\mathbf{X}_{t+k}$ such that its $(i,j)$th  element is the cross-covariance coefficient of $X_{it}$ and $X_{j, t+k}.$
- A multivariate process is said to be **second-order stationary** if  the mean and the cross-covariance matrices at different lags do not depend on time.
- Then $\mathbf{\mu}_t$ will be a constant (say $\mathbf{\mu}$) and $\Gamma(t,t+k)$ will be a function of the lag $k$ only ( $\Gamma(k)$).
- Then $\gamma_{ij}(k)$, the $(i,j)$th element of ($\Gamma(k)$) can be written as 

$$\gamma_{ij}(k)=\text{Cov}(X_{it},X_{j,t+k} )= E[(X_{it}-\mu_i)(X_{j,t+k}-\mu_j)]$$

- In the stationary case, the set of cross-covariance matrices, $\Gamma(k)$ for $k=0, \pm1, \pm2, \dots,$ is known as **covariance matrix function**.
- Since 

$$\gamma_{ij}(k)= \text{Cov}(X_{it},X_{j,t+k} )= \text{Cov}(X_{j,t+k}, X_{it} ) = \gamma_{ij}(-k),$$

we have 
$$\Gamma(k)=\Gamma^T(-k), \quad k=0, \pm1, \pm2, \dots.$$
- The diagonal terms, $\gamma_{ii}(k)$, are auto- rather than cross- covariances, and therefore have the property of being an even function of lags.


**Cross-correlation**

- Let $R(k)$ be the **cross-correlation matrix function** of the process.
- The $(i,j)$the element of $R(k)$ is given by

$$\rho_{ij}(k)= \text{Corr}(X_{j,t+k}, X_{it} )=\gamma_{ij}(k)/\sigma_i\sigma_j$$
where $\sigma_i$  is the standard deviations of $X_{it}$ (this can also be expressed as $\sqrt{\gamma_{ii}(0)}.$)
- When $k>0$, the correlation coefficient measures the linear dependence of $X_{j, t+k}$ on $X_{it},$ which occurs after time $t$.
- If $\rho_{ij}(k)\neq0$ and $k>0$, the series $X_{it}$ leads the series $X_{jt}$ at lag $k$.
- Furthermore, we can write 
$$R(K)=R^T(-k), \quad \quad k=0, \pm1, \pm2, \dots.$$
- Therefore, in practice, it is enough to consider the cross-correlation matrices $R(k)$ for $k>0$.

**Sample cross-correlation coefficient**

- Let $T$ be the total number of observations collected on the $m$ variables over the same time period.
- Then the **sample cross-covariance** coefficient of $X_i$ and $X_j$ at lag $k$ is given by

\[
    c_{ij}(k)= 
\begin{cases}
    \sum_{t=1}^{T-k}(x_{it}-\bar{x_i})(x_{j,t+k}-\bar{x_j})/ T,& \quad k=0, 1,2, \dots,(T-1)\\
\sum_{t=1-k}^{T}(x_{it}-\bar{x_i})(x_{j,t+k}-\bar{x_j})/ T,& \quad k=-1,-2, \dots,-(T-1).
\end{cases}
\]

- The **sample cross-correlation** coefficient of  $X_i$ and $X_j$ at lag $k$ is given by 
$$\gamma_{ij}(k)=c_{ij}(k)/s_is_j$$
where $s_i=\sqrt{c_{ii}(0)}$ is the sample standard deviation of observations on the $i$th variable. 

<!-- #The ticker symbol for the S&P 500 index is ^GSPC.

, also known as the Dow 30, is a stock market index that tracks 30 large, publicly-owned blue-chip companies trading on the New York Stock Exchange and the NASDAQ

The Nasdaq Composite (ticker symbol ^IXIC) is a stock market index that includes almost all stocks listed on the Nasdaq stock market. Along with the Dow Jones Industrial Average and S&P 500 Index, it is one of the three most-followed stock market indices in the United States.
-->

*Example*

- Consider the daily returns of adjusted closing prices of the Standard & Poor's 500 (S&P500), the Dow Jones Industrial Average and the Nasdaq Composite indices  from January 4, 1995 to February 25, 2021 (Figure \@ref(fig:stock) .
- These three market indices characterize the performance of the U.S. stock market from different perspectives and therefore they should be highly correlated.
- Figure \@ref(fig:ccf) shows their sample correlations at lag $k=0,1,\dots, 25.$


```{r stock, cache=TRUE, echo=TRUE, fig.cap="Daily returns of adjusted closing prices of the Standard & Poor's 500 (S&P500), the Dow Jones Indutrial Average and the Nasdaq Composite indices  from January 4, 1995 to February 25, 2021"}
# Tidy financial analysis 
library(tidyquant)

#S&P 500 index
sp500 <- tq_get("^GSPC", from = "1995-01-04", to = "2021-02-25" )
print(sp500)
# The Dow Jones Industrial Average (DJIA)
dji<- tq_get("^DJI", from = "1995-01-04", to = "2021-02-25" )
print(dji)
# The Nasdaq Composite 
nasdaq<- tq_get("^IXIC", from = "1995-01-04", to = "2021-02-25" )
print(nasdaq)

# Convert each assets raw adjusted closing prices to returns
sp500_return <- sp500 %>% 
  tq_transmute(select     = adjusted, 
               mutate_fun = periodReturn, 
               period     = "daily")

dji_return <- dji %>% 
  tq_transmute(select     = adjusted, 
               mutate_fun = periodReturn, 
               period     = "daily")

nasdaq_return <- nasdaq %>% 
  tq_transmute(select     = adjusted, 
               mutate_fun = periodReturn, 
               period     = "daily")

p1 <- sp500_return %>% 
  as_tsibble(index = date) %>%
  autoplot(daily.returns) +
  labs(x = "Day", y= "S&P500")
p2 <- dji_return %>% 
  as_tsibble(index = date) %>%
  autoplot(daily.returns) +
  labs(x = "Day", y= "Dow Jones")
p3 <- nasdaq_return %>% 
  as_tsibble(index = date) %>%
  autoplot(daily.returns) +
  labs(x = "Day", y= "Nasdaq")

p1 / p2/ p3

```

**A function of computing sample cross correlation**

```{r ccf, echo=TRUE, results='hide',fig.keep='all'}
library(MTS)
data <- full_join(sp500_return, dji_return, by= "date" )
data <- full_join(data, nasdaq_return, by ="date" )
colnames(data) <- c("date", "sp500", "dji", "nasdaq")

ret <- data %>% 
   select(sp500, dji, nasdaq) %>%
   as.matrix()
MTSplot(ret)
ccm(ret, lags = 25)
```

- The concurrent interdependence of the three series are very strong.
- However, the lead-lag effect among the three series is relativey weak.



## References:

- Chatfield, C., & Xing, H. (2019). The analysis of time series: an introduction with R. CRC press.

- Tsay, R. S. (2013). Multivariate time series analysis: with R and financial applications. John Wiley & Sons.
