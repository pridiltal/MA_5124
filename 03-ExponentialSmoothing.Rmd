# Exponential Smoothing 

```{r setup3, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=TRUE, warning=FALSE, message=FALSE)
options(digits=4, width=60)
library(fpp3)
library(patchwork)
library(purrr)
library(tidyverse)

```

\pagenumbering{arabic}
## Introduction

### Historical perspective

 * Developed in the 1950s and 1960s as methods (algorithms) to produce point forecasts.
 * Combine a "level", "trend" (slope) and "seasonal" component to describe a time series.
 * The rate of change of the components are controlled by "smoothing parameters":\newline $\alpha$, $\beta$ and $\gamma$ respectively.
  * Need to choose best values for the smoothing parameters (and initial states).
  * Equivalent ETS state space models developed in the 1990s and 2000s.


### Big idea: control the rate of change

$\alpha$ controls the flexibility of the **level**

* If $\alpha = 0$, the level never updates (mean)
* If $\alpha = 1$, the level updates completely (naive)

$\beta$ controls the flexibility of the **trend**

* If $\beta = 0$, the trend is linear (regression trend)
* If $\beta = 1$, the trend updates every observation

$\gamma$ controls the flexibility of the **seasonality**

* If $\gamma = 0$, the seasonality is fixed (seasonal means)
* If $\gamma = 1$, the seasonality updates completely (seasonal naive)

### A model for levels, trends, and seasonalities

We want a model that captures the level ($\ell_t$), trend ($b_t$) and seasonality ($s_t$).

**How do we combine these elements?**

- Additively?

$$y_t = \ell_{t-1} + b_{t-1} + s_{t-m} + \varepsilon_t$$

- Multiplicatively?

$$y_t = \ell_{t-1}b_{t-1}s_{t-m}(1 + \varepsilon_t)$$

- Perhaps a mix of both?

$$y_t = (\ell_{t-1} + b_{t-1}) s_{t-m} + \varepsilon_t$$

**How do the level, trend and seasonal components evolve over time?**

General notation:

$$\text{ETS: } \textbf{E}\text{xponen}\textbf{T}\text{ial}\textbf{ S}\text{moothing}$$


**E**rror: Additive (`"A"`) or multiplicative (`"M"`)

**T**rend: None (`"N"`), additive (`"A"`), multiplicative (`"M"`), or damped (`"Ad"` or `"Md"`).

**S**easonality: None (`"N"`), additive (`"A"`) or multiplicative (`"M"`)

## Simple exponential smoothing

Time series $y_1,y_2,\dots,y_T$.

**Random walk forecasts**
$$\hat{y}_{T+h|T} = y_T$$

**Average forecasts**

$$\hat{y}_{T+h|T} = \frac1T\sum_{t=1}^T y_t$$


* Want something in between these methods.
* Most recent data should have more weight.

<!-- * Simple exponential smoothing uses a weighted moving average with weights that decrease exponentially. -->

**Forecast equation**

$$\hat{y}_{T+1|T} = \alpha y_T + \alpha(1-\alpha) y_{T-1} + \alpha(1-\alpha)^2 y_{T-2}+ \cdots$$

where $0 \le \alpha \le1$

\small\begin{tabular}{lllll}
\toprule
& \multicolumn{4}{l}{Weights assigned to observations for:}\\
Observation  &   $\alpha = 0.2$   &   $\alpha = 0.4$  &   $\alpha = 0.6$  & $\alpha = 0.8$ \\
\midrule
$y_{T}$      & 0.2         & 0.4          & 0.6         & 0.8\\
$y_{T-1}$    & 0.16        & 0.24         & 0.24        & 0.16\\
$y_{T-2}$    & 0.128       & 0.144        & 0.096       & 0.032\\
$y_{T-3}$    & 0.1024      & 0.0864       & 0.0384      & 0.0064\\
$y_{T-4}$    & $(0.2)(0.8)^4$  & $(0.4)(0.6)^4$   & $(0.6)(0.4)^4$  & $(0.8)(0.2)^4$\\
$y_{T-5}$    & $(0.2)(0.8)^5$  & $(0.4)(0.6)^5$   & $(0.6)(0.4)^5$  & $(0.8)(0.2)^5$\\
\bottomrule
\end{tabular}

<!-- animation-->

**Component form**

- Forecast equation $\hat{y}_{t+h|t} = \ell_{t}$

- Smoothing equation $\ell_{t} = \alpha y_{t} + (1 - \alpha)\ell_{t-1}$

* $\ell_t$ is the level (or the smoothed value) of the series at time t.
* $\hat{y}_{t+1|t} = \alpha y_t + (1-\alpha) \hat{y}_{t|t-1}$\newline
Iterate to get exponentially weighted moving average form.
  
**Weighted average form**

$$\hat{y}_{T+1|T}=\sum_{j=0}^{T-1} \alpha(1-\alpha)^j y_{T-j}+(1-\alpha)^T \ell_{0}$$

### Optimising smoothing parameters

* Need to choose best values for $\alpha$ and $\ell_0$.
  * Similarly to regression, choose optimal parameters by minimising SSE:
  
$$\text{SSE}=\sum_{t=1}^T(y_t-\hat{y}_{t|t-1})^2.$$

  * Unlike regression there is no closed form solution --- use numerical optimization.
 
```{r ses, echo=FALSE}
algeria_economy <- global_economy %>%
  filter(Country == "Algeria")
fit <- algeria_economy %>%
  model(
    ETS(Exports ~ error("A") + trend("N") + season("N"))
  )
``` 

 * For Algerian Exports example:
    - $\hat\alpha = `r sprintf("%4.4f",tidy(fit)[1,4])`$
    - $\hat\ell_0 = `r sprintf("%4.2f",tidy(fit)[2,4])`$
    
    ```{r alpha-static, fig.height=5, fig.width=8}
alpha_static <- map_dfr(list(0, as.numeric(tidy(fit)[1,4]), 1), function(alpha){
  fit <- algeria_economy %>%
    model(ETS(Exports ~ error("A") + trend("N", alpha = alpha, alpha_range = c(-0.01,1),
          beta_range = c(-1,1)) + season("N", gamma_range = c(-1,1)), bounds = "admissible"))
  fit %>%
    augment() %>%
    mutate(alpha = tidy(fit)$estimate[tidy(fit)$term == "alpha"]) %>%
    as_tibble()
}) %>%
  mutate(alpha = factor(format(alpha)))
algeria_economy %>%
  ggplot(aes(x = Year, y = Exports)) +
  geom_line() +
  geom_line(aes(y = .fitted, colour = alpha), data = alpha_static) +
  ylab("Exports (% of GDP)") +
  ggtitle("Algerian exports of goods and services: level")
```


### Models and methods

#### Methods

  * Algorithms that return point forecasts.

#### Models

  * Generate same point forecasts but can also generate forecast distributions.
  * A stochastic (or random) data generating process that can generate an entire forecast distribution.
  * Allow for "proper" model selection.

### ETS(A,N,N): A model for SES
  
**Component form**

- Forecast equation: $\hat{y}_{t+h|t} = \ell_{t}$

- Smoothing equation: $\ell_{t} = \alpha y_{t} + (1 - \alpha)\ell_{t-1}$

Forecast error: $e_t = y_t - \hat{y}_{t|t-1} = y_t - \ell_{t-1}$

**Error correction form**

$$y_t = \ell_{t-1} + e_t$$
$$\ell_{t}= \ell_{t-1}+\alpha( y_{t}-\ell_{t-1})$$

$\ell_{t}=\ell_{t-1}+\alpha e_{t}$

Specify probability distribution for $e_t$, we assume $e_t = \varepsilon_t\sim\text{NID}(0,\sigma^2)$.

### ETS(A,N,N)

- Measurement equation: $y_t = \ell_{t-1} + \varepsilon_t$

- State equation: $\ell_t=\ell_{t-1}+\alpha \varepsilon_t$

where $\varepsilon_t\sim\text{NID}(0,\sigma^2)$.

* "innovations" or "single source of error" because equations have the same error process, $\varepsilon_t$.
  * Measurement equation: relationship between observations and states.
  * State equation(s): evolution of the state(s) through time.
  
### ETS(M,N,N)

SES with multiplicative errors.

* Specify relative errors  $\varepsilon_t=\frac{y_t-\hat{y}_{t|t-1}}{\hat{y}_{t|t-1}}\sim \text{NID}(0,\sigma^2)$
  * Substituting $\hat{y}_{t|t-1}=\ell_{t-1}$ gives:
    * $y_t = \ell_{t-1}+\ell_{t-1}\varepsilon_t$
    * $e_t = y_t - \hat{y}_{t|t-1} = \ell_{t-1}\varepsilon_t$
    
- Measurement equation: $y_t = \ell_{t-1}(1 + \varepsilon_t)$
- State equation: $\ell_t=\ell_{t-1}(1+\alpha \varepsilon_t)$

* Models with additive and multiplicative errors with the same parameters generate the same point forecasts but different prediction intervals.

### ETS(A,N,N): Specifying the model

```{r ann-spec, echo = TRUE, results = "hide"}
ETS(y ~ error("A") + trend("N") + season("N"))
```

By default, an optimal value for $\alpha$ and $\ell_0$ is used.

$\alpha$ can be chosen manually in `trend()`.

```{r alpha-spec, echo = TRUE, eval = FALSE}
trend("N", alpha = 0.5)
trend("N", alpha_range = c(0.2, 0.8))
```

### Example: Algerian Exports

```{r ses-fit, echo=TRUE, cache=TRUE}
algeria_economy <- global_economy %>%
  filter(Country == "Algeria")
fit <- algeria_economy %>%
  model(ANN = ETS(Exports ~ error("A") + trend("N") + season("N")))
report(fit)
```

```{r ses-cmp0, echo = TRUE}
components(fit) %>% autoplot()
```

```{r ses-cmp, echo = TRUE}
components(fit) %>%
  left_join(fitted(fit), by = c("Country", ".model", "Year"))
```

```{r ses-fc, echo=TRUE, cache=TRUE}
fit %>%
  forecast(h = 5) %>%
  autoplot(algeria_economy) +
  ylab("Exports (% of GDP)") + xlab("Year")
```